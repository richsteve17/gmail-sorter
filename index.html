<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <title>Gmail Sorter</title>
    <link rel="stylesheet" href="styles.css">
</head>
<body>
    <div id="loginScreen" class="screen">
        <div class="login-container">
            <div class="logo">ðŸ“§</div>
            <h1>Gmail Sorter</h1>
            <p class="subtitle">Casino â€¢ OTP â€¢ Social â€¢ Shopping â€¢ Auto-sorted</p>
            
            <!-- FIX: Use a real button with ID instead of inline onclick -->
            <button id="signInButton" class="google-signin-btn">Sign in with Google</button>
            
            <!-- DEBUG: Show errors -->
            <div id="errorMessage" style="color: red; margin-top: 20px; display: none;"></div>
        </div>
    </div>

    <div id="appScreen" class="screen hidden">
        <header class="app-header">
            <h1>Inbox</h1>
            <button id="signOutBtn" class="icon-btn">ðŸšª</button>
            <div class="category-pills" id="categoryPills"></div>
        </header>
        <main class="email-list" id="emailList"></main>
    </div>

    <script>
        // Configuration
        const CONFIG = {
            GOOGLE_CLIENT_ID: '469028529540-399r7m34gkt3n05r7ss572jmkpbl5np8.apps.googleusercontent.com',
            GEMINI_API_KEY: 'PASTE_YOUR_GEMINI_KEY_HERE',
            GMAIL_SCOPES: 'https://www.googleapis.com/auth/gmail.readonly',
            MAX_EMAILS: 50,
        };

        const EMAIL_CATEGORIES = {
            casino: { name: 'Casino', icon: 'ðŸŽ°', color: 'casino', keywords: ['casino','bet','poker','slots','blackjack','roulette','gambling','wager','bonus'] },
            otp: { name: 'OTP/2FA', icon: 'ðŸ”', color: 'otp', keywords: ['code','verification','otp','2fa','verify','login code','security'] },
            social: { name: 'Social', icon: 'ðŸ‘¥', color: 'social', keywords: ['facebook','twitter','instagram','linkedin','social','friend','follow','comment'] },
            shopping: { name: 'Shopping', icon: 'ðŸ›ï¸', color: 'shopping', keywords: ['order','amazon','ebay','shipping','delivery','purchase','payment','receipt'] },
            promotions: { name: 'Promo', icon: 'ðŸ“¢', color: 'promo', keywords: ['sale','discount','offer','deal','promo','coupon','save','limited time'] },
            finance: { name: 'Finance', icon: 'ðŸ’°', color: 'finance', keywords: ['bank','transaction','statement','balance','payment','invoice','account'] },
            general: { name: 'General', icon: 'ðŸ“§', color: 'general', keywords: [] },
        };

        let accessToken = null;

        // DEBUG: Check if script is loading
        console.log('âœ… App loaded. CONFIG:', CONFIG);
        console.log('âœ… Current URL:', window.location.href);

        // MAIN FIX: Attach event listener AFTER DOM loads
        document.addEventListener('DOMContentLoaded', function() {
            console.log('âœ… DOM loaded, attaching event listeners');
            
            const signInBtn = document.getElementById('signInButton');
            const signOutBtn = document.getElementById('signOutBtn');
            
            if (signInBtn) {
                signInBtn.addEventListener('click', signInWithGoogle);
                console.log('âœ… Sign-in button listener attached');
            } else {
                console.error('âŒ Sign-in button not found!');
            }
            
            if (signOutBtn) {
                signOutBtn.addEventListener('click', signOut);
            }
            
            // Check OAuth callback
            if (handleOAuth()) {
                loadEmails();
            } else if (localStorage.getItem('gmail_access_token')) {
                accessToken = localStorage.getItem('gmail_access_token');
                loadEmails();
            }
        });

        function signInWithGoogle() {
            console.log('ðŸ”„ Starting Google sign-in...');
            
            const clientId = CONFIG.GOOGLE_CLIENT_ID;
            const redirectUri = window.location.origin + window.location.pathname;
            const scope = encodeURIComponent(CONFIG.GMAIL_SCOPES);
            
            // IOS FIX: Use direct window.location instead of popup
            const authUrl = `https://accounts.google.com/o/oauth2/v2/auth?client_id=${clientId}&redirect_uri=${encodeURIComponent(redirectUri)}&response_type=token&scope=${scope}&prompt=consent`;
            
            console.log('ðŸŒ Redirecting to:', authUrl);
            window.location.href = authUrl;
        }

        function signOut() {
            console.log('ðŸšª Signing out...');
            localStorage.removeItem('gmail_access_token');
            window.location.reload();
        }

        function handleOAuth() {
            const hash = window.location.hash;
            if (hash && hash.includes('access_token')) {
                console.log('âœ… OAuth callback detected');
                const params = new URLSearchParams(hash.substring(1));
                accessToken = params.get('access_token');
                localStorage.setItem('gmail_access_token', accessToken);
                window.history.replaceState(null, null, window.location.pathname);
                return true;
            }
            return false;
        }

        async function loadEmails() {
            try {
                console.log('ðŸ“§ Loading emails...');
                
                document.getElementById('loginScreen').classList.add('hidden');
                document.getElementById('appScreen').classList.remove('hidden');

                const token = accessToken || localStorage.getItem('gmail_access_token');
                if (!token) throw new Error('Not signed in');

                // Fetch emails
                const response = await fetch(
                    `https://gmail.googleapis.com/gmail/v1/users/me/messages?maxResults=${CONFIG.MAX_EMAILS}&q=in:inbox`,
                    { headers: { 'Authorization': `Bearer ${token}` } }
                );
                
                if (!response.ok) throw new Error(`HTTP ${response.status}`);
                
                const data = await response.json();
                const emails = await Promise.all(data.messages.map(msg => fetchEmail(msg.id, token)));

                // Categorize emails
                if (CONFIG.GEMINI_API_KEY && !CONFIG.GEMINI_API_KEY.includes('PASTE')) {
                    await categorizeWithGemini(emails);
                } else {
                    // Fallback to keyword matching
                    emails.forEach(email => {
                        const content = (email.subject + ' ' + email.from).toLowerCase();
                        for (const [id, cat] of Object.entries(EMAIL_CATEGORIES)) {
                            if (cat.keywords.some(k => content.includes(k))) {
                                email.category = id;
                                break;
                            }
                        }
                    });
                }

                renderEmails(emails);
                console.log('âœ… Emails loaded and categorized');
                
            } catch (error) {
                console.error('âŒ Error loading emails:', error);
                document.getElementById('errorMessage').textContent = 'Error: ' + error.message;
                document.getElementById('errorMessage').style.display = 'block';
            }
        }

        async function fetchEmail(id, token) {
            const response = await fetch(
                `https://gmail.googleapis.com/gmail/v1/users/me/messages/${id}?format=full`,
                { headers: { 'Authorization': `Bearer ${token}` } }
            );
            
            const msg = await response.json();
            const headers = msg.payload.headers;
            
            return {
                id,
                subject: headers.find(h => h.name === 'Subject')?.value || 'No Subject',
                from: headers.find(h => h.name === 'From')?.value || 'Unknown',
                date: new Date(headers.find(h => h.name === 'Date')?.value || Date.now()),
                snippet: msg.snippet || '',
                category: 'uncategorized'
            };
        }

        async function categorizeWithGemini(emails) {
            const apiKey = CONFIG.GEMINI_API_KEY;
            
            for (let i = 0; i < emails.length; i++) {
                const email = emails[i];
                const categoryNames = Object.keys(EMAIL_CATEGORIES).join(', ');
                const prompt = `Categorize this email into ONE of these: ${categoryNames}. Just respond with the category name.\n\nEmail: "${email.subject}" from "${email.from}"`;
                
                const response = await fetch(
                    `https://generativelanguage.googleapis.com/v1beta/models/gemini-pro:generateContent?key=${apiKey}`,
                    {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ contents: [{ parts: [{ text: prompt }] }] })
                    }
                );
                
                const data = await response.json();
                const category = data.candidates[0].content.parts[0].text.trim().toLowerCase();
                if (EMAIL_CATEGORIES[category]) email.category = category;
            }
        }

        function renderEmails(emails) {
            const pills = document.getElementById('categoryPills');
            const list = document.getElementById('emailList');
            
            // Count emails per category
            const counts = {};
            Object.keys(EMAIL_CATEGORIES).forEach(id => counts[id] = 0);
            emails.forEach(e => counts[e.category]++);
            
            // Render category pills
            let pillsHTML = `<button class="pill active" onclick="filterEmails('all')">All ${emails.length}</button>`;
            for (const [id, count] of Object.entries(counts)) {
                if (count > 0) {
                    const cat = EMAIL_CATEGORIES[id];
                    pillsHTML += `<button class="pill" onclick="filterEmails('${id}')">${cat.icon} ${cat.name} ${count}</button>`;
                }
            }
            pills.innerHTML = pillsHTML;
            
            // Render email list
            list.innerHTML = emails.map(e => {
                const cat = EMAIL_CATEGORIES[e.category];
                const sender = e.from.split('<')[0].trim();
                return `
                    <div class="email-item" onclick="window.open('https://mail.google.com/mail/u/0/#inbox/${e.id}', '_blank')">
                        <div class="category-badge badge-${cat.color}">${cat.icon} ${cat.name}</div>
                        <div class="email-sender">${sender}</div>
                        <div class="email-subject">${e.subject}</div>
                        <div class="email-snippet">${e.snippet}</div>
                    </div>
                `;
            }).join('');
        }

        function filterEmails(category) {
            alert('Filtering by ' + category + ' - refresh to see all');
        }
    </script>
</body>
</html>
